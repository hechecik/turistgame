<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>G & N: Neon Wars</title>
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Montserrat:wght@900&display=swap');

    :root {
        --bg-color: #050505;
        --neon-g: #ff0055;
        --neon-n: #ffcc00;
        --neon-blue: #00f3ff;
        --glass: rgba(255, 255, 255, 0.08);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

    body {
        margin: 0; height: 100vh; width: 100vw; overflow: hidden;
        background: radial-gradient(circle at center, #1a0b1a 0%, #000 100%);
        color: #fff; font-family: 'Orbitron', sans-serif;
        display: flex; flex-direction: column; align-items: center;
        touch-action: none;
    }

    #menu-layer {
        position: absolute; inset: 0; z-index: 2000;
        background: rgba(0,0,0,0.98);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
    }

    .title {
        font-size: 5rem; letter-spacing: 5px; margin-bottom: 10px;
        background: linear-gradient(90deg, var(--neon-g), var(--neon-n));
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        background-clip: text;
        filter: drop-shadow(0 0 20px rgba(255, 0, 85, 0.5));
        text-align: center;
    }
    .subtitle { font-size: 1rem; color: #888; letter-spacing: 4px; margin-bottom: 50px; }

    .btn {
        padding: 20px; width: 80%; max-width: 300px; margin: 10px;
        border: none; border-radius: 50px; font-size: 1.1rem; font-weight: bold;
        cursor: pointer; font-family: 'Orbitron'; text-transform: uppercase;
        transition: transform 0.1s;
    }
    .btn-create { background: var(--neon-blue); color: #000; box-shadow: 0 0 20px rgba(0,243,255,0.3); }
    .btn-local { background: transparent; border: 2px solid #444; color: #aaa; }
    .btn:active { transform: scale(0.95); }

    .link-area {
        display: none; flex-direction: column; align-items: center; gap: 15px; width: 90%; max-width: 400px;
        background: #111; padding: 25px; border-radius: 20px; border: 1px solid #333;
    }
    .link-input {
        width: 100%; padding: 15px; background: #000; border: 1px solid var(--neon-blue);
        color: var(--neon-blue); text-align: center; border-radius: 10px; font-family: monospace;
        font-size: 0.9rem; word-break: break-all;
    }
    #debug-log {
        margin-top: 20px; font-size: 0.8rem; color: #555; font-family: monospace;
        max-width: 90%; text-align: center;
    }

    #game-layer {
        display: none; flex-direction: column; align-items: center; width: 100%; height: 100%;
        padding-top: 20px;
    }

    .hud {
        display: flex; justify-content: space-between; align-items: center; width: 90%; max-width: 450px;
        background: var(--glass); padding: 15px 30px; border-radius: 50px;
        margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1);
    }
    .score-box { text-align: center; opacity: 0.5; transition: 0.3s; }
    .score-box.active { opacity: 1; transform: scale(1.1); filter: drop-shadow(0 0 10px currentColor); }
    .score-val { font-size: 2rem; display: block; }
    .c-g { color: var(--neon-g); } .c-n { color: var(--neon-n); }

    .board-wrap {
        position: relative; width: 90vmin; height: 90vmin; max-width: 400px; max-height: 400px;
        background: #111; border-radius: 20px;
        box-shadow: 0 0 50px rgba(0,0,0,0.5);
        border: 1px solid #333; margin-bottom: 20px;
        touch-action: none; 
    }

    svg.lines { width: 100%; height: 100%; position: absolute; pointer-events: none; }
    line { stroke: #333; stroke-width: 4; stroke-linecap: round; }

    .spot {
        position: absolute; width: 25%; height: 25%;
        transform: translate(-50%, -50%); border-radius: 50%; z-index: 5;
    }

    .piece {
        position: absolute; width: 16%; height: 16%;
        border-radius: 50%; z-index: 10; cursor: grab;
        display: flex; align-items: center; justify-content: center;
        font-family: 'Montserrat', sans-serif; font-weight: 900; font-size: 1.8rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.8);
        background: #1a1a1a; transition: transform 0.1s;
        touch-action: none;
    }
    .piece:active { transform: scale(1.2); cursor: grabbing; }
    
    .piece.red { border: 2px solid var(--neon-g); color: var(--neon-g); text-shadow: 0 0 15px var(--neon-g); }
    .piece.red::after { content: 'G'; }

    .piece.yellow { border: 2px solid var(--neon-n); color: var(--neon-n); text-shadow: 0 0 15px var(--neon-n); }
    .piece.yellow::after { content: 'N'; }

    .pools { display: flex; width: 90%; max-width: 400px; justify-content: space-between; height: 15%; }
    .pool { width: 45%; background: var(--glass); border-radius: 15px; position: relative; display: flex; gap: 5px; padding: 5px; }

    .modal {
        position: fixed; inset: 0; background: rgba(0,0,0,0.95);
        display: none; align-items: center; justify-content: center; z-index: 3000;
        flex-direction: column; gap: 20px;
    }
    .modal h2 { font-size: 2.5rem; margin: 0; }
    .toast {
        position: fixed; top: 20px; background: #222; color: var(--neon-blue); padding: 10px 20px;
        border-radius: 20px; opacity: 0; transition: 0.3s; border: 1px solid var(--neon-blue); z-index: 5000;
    }

    @media (max-width: 600px) {
        .title { font-size: 3rem; }
        .piece { font-size: 1.5rem; }
    }
</style>
</head>
<body>

    <div id="menu-layer">
        <div class="title">G & N</div>
        <div class="subtitle">SONSUZ DÜELLO</div>
        
        <div id="main-btns" style="display:flex; flex-direction:column; align-items:center; width:100%">
            <button class="btn btn-create" id="btn-online">Link Oluştur</button>
            <button class="btn btn-local" id="btn-local">İnternetsiz Oyna</button>
        </div>

        <div class="link-area" id="link-area">
            <p style="color:#aaa; margin:0">Bu linki rakibine at:</p>
            <input class="link-input" id="share-link" readonly value="Bağlanıyor...">
            <button class="btn btn-create" id="btn-copy" style="padding:15px; font-size:1rem; width:100%">Kopyala</button>
            <p id="status-msg" style="color:var(--neon-n); margin-top:10px">Sunucuya bağlanıyor...</p>
            <button class="btn btn-local" id="btn-cancel" style="margin-top:20px; font-size:0.8rem; padding:10px">İptal</button>
        </div>
        <div id="debug-log"></div>
    </div>

    <div id="game-layer">
        <div class="hud">
            <div class="score-box c-g" id="p1-stat"><span class="score-val" id="s1">0</span><small>G TAKIMI</small></div>
            <div style="font-size:0.8rem; color:#666" id="turn-text">VS</div>
            <div class="score-box c-n" id="p2-stat"><span class="score-val" id="s2">0</span><small>N TAKIMI</small></div>
        </div>

        <div class="board-wrap" id="board">
            <svg class="lines">
                <line x1="10%" y1="10%" x2="90%" y2="10%"/><line x1="90%" y1="10%" x2="90%" y2="90%"/>
                <line x1="90%" y1="90%" x2="10%" y2="90%"/><line x1="10%" y1="90%" x2="10%" y2="10%"/>
                <line x1="50%" y1="10%" x2="50%" y2="90%"/><line x1="10%" y1="50%" x2="90%" y2="50%"/>
                <line x1="10%" y1="10%" x2="90%" y2="90%"/><line x1="90%" y1="10%" x2="10%" y2="90%"/>
            </svg>
        </div>

        <div class="pools">
            <div class="pool" id="pool-R"></div>
            <div class="pool" id="pool-Y"></div>
        </div>
    </div>

    <div class="modal" id="end-modal">
        <h2 id="end-msg">KAZANDIN!</h2>
        <button class="btn btn-create" id="btn-next">Sonraki Tur</button>
    </div>

    <div class="modal" id="disc-modal">
        <h2 style="color:#888; font-size:1.5rem">Bağlantı Koptu</h2>
        <button class="btn btn-create" id="btn-reconnect">Ana Menü</button>
    </div>

    <div class="toast" id="toast">Kopyalandı!</div>

<script>
    const pos = [{l:10,t:10},{l:50,t:10},{l:90,t:10},{l:10,t:50},{l:50,t:50},{l:90,t:50},{l:10,t:90},{l:50,t:90},{l:90,t:90}];
    const adj = [[1,3,4],[0,2,4],[1,5,4],[0,4,6],[0,1,2,3,5,6,7,8],[2,4,8],[3,4,7],[6,4,8],[4,5,7]];
    const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];

    let mode = 'local';
    let myRole = 'both';
    let state = { board:Array(9).fill(null), turn:'R', phase:'placing', placed:{R:0,Y:0}, score:{R:0,Y:0}, winner:null };
    let peer = null, conn = null;
    let peerInitialized = false;
    let connectionTimeout = null;

    function log(msg) {
        const debugEl = document.getElementById('debug-log');
        debugEl.innerText = msg;
        console.log('[G&N]', msg);
    }

    window.addEventListener('load', () => {
        createSpots();
        
        document.getElementById('btn-local').onclick = startLocal;
        document.getElementById('btn-online').onclick = initHost;
        document.getElementById('btn-copy').onclick = copyLink;
        document.getElementById('btn-next').onclick = nextRound;
        document.getElementById('btn-cancel').onclick = () => location.reload();
        document.getElementById('btn-reconnect').onclick = () => location.reload();

        // URL'den ID'yi al (hash veya query)
        const hash = window.location.hash.slice(1);
        const urlParams = new URLSearchParams(window.location.search);
        const joinId = hash || urlParams.get('id');
        
        if(joinId) {
            log('Join modu tespit edildi: ' + joinId);
            setTimeout(() => initJoin(joinId), 500);
        }
    });

    function createSpots() {
        const board = document.getElementById('board');
        pos.forEach((p,i)=>{
            let s = document.createElement('div');
            s.className='spot'; 
            s.style.left=p.l+'%'; 
            s.style.top=p.t+'%'; 
            s.dataset.idx=i;
            board.appendChild(s);
        });
    }

    function startLocal() {
        mode = 'local';
        myRole = 'both';
        document.getElementById('menu-layer').style.display='none';
        document.getElementById('game-layer').style.display='flex';
        render();
    }

    function getPeerConfig() {
        return {
            debug: 2,
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' },
                    { urls: 'stun:global.stun.twilio.com:3478' }
                ],
                iceTransportPolicy: 'all'
            }
        };
    }

    function initHost() {
        if(peerInitialized) return;
        peerInitialized = true;
        
        document.getElementById('main-btns').style.display='none';
        document.getElementById('link-area').style.display='flex';
        log("Host modu başlatılıyor...");

        try {
            peer = new Peer(getPeerConfig());
            
            connectionTimeout = setTimeout(() => {
                if(!conn || !conn.open) {
                    log("Bağlantı zaman aşımı");
                    alert("Sunucuya bağlanılamadı. İnternet bağlantınızı kontrol edip tekrar deneyin.");
                    location.reload();
                }
            }, 30000);
            
            peer.on('open', id => {
                log("Peer ID alındı: " + id);
                const baseUrl = window.location.origin + window.location.pathname;
                const shareUrl = baseUrl + '#' + id;
                document.getElementById('share-link').value = shareUrl;
                document.getElementById('status-msg').innerText = "✓ Hazır! Rakip bekleniyor...";
                document.getElementById('status-msg').style.color = "var(--neon-blue)";
            });

            peer.on('connection', c => {
                log("Rakip bağlandı!");
                clearTimeout(connectionTimeout);
                conn = c;
                setupConn();
                myRole = 'R';
                mode = 'online';
                document.getElementById('status-msg').innerText = "✓ BAĞLANDI! Oyun başlıyor...";
                document.getElementById('status-msg').style.color = "#0f0";
                
                setTimeout(() => {
                    document.getElementById('menu-layer').style.display='none';
                    document.getElementById('game-layer').style.display='flex';
                    sendState();
                    render();
                }, 1500);
            });

            peer.on('error', err => {
                clearTimeout(connectionTimeout);
                log("Peer hatası: " + err.type);
                console.error(err);
                
                if(err.type === 'unavailable-id') {
                    alert("ID meşgul. Sayfayı yenileyip tekrar deneyin.");
                } else if(err.type === 'network') {
                    alert("Ağ hatası. İnternet bağlantınızı kontrol edin.");
                } else {
                    alert("Bağlantı hatası: " + err.type);
                }
                location.reload();
            });

            peer.on('disconnected', () => {
                log("Peer bağlantısı kesildi");
                if(!conn || !conn.open) {
                    peer.reconnect();
                }
            });
            
        } catch(e) {
            log("Kritik hata: " + e.message);
            console.error(e);
            alert("Başlatma hatası. Sayfayı yenileyin.");
        }
    }

    function initJoin(id) {
        if(peerInitialized) return;
        peerInitialized = true;
        
        document.getElementById('main-btns').style.display='none';
        log("Odaya bağlanılıyor: " + id);
        
        const msg = document.createElement('div');
        msg.innerText = "BAĞLANIYOR...";
        msg.style.color = "var(--neon-blue)";
        msg.style.fontSize = "1.5rem";
        msg.style.marginTop = "30px";
        document.getElementById('menu-layer').appendChild(msg);

        try {
            peer = new Peer(getPeerConfig());
            
            connectionTimeout = setTimeout(() => {
                log("Bağlantı zaman aşımı");
                alert("Odaya bağlanılamadı. Link geçersiz veya host çevrimdışı.");
                location.href = window.location.pathname;
            }, 20000);
            
            peer.on('open', myId => {
                log("Bağlantı kurulmaya çalışılıyor...");
                msg.innerText = "BAĞLANIYOR...";
                
                conn = peer.connect(id, {
                    reliable: true,
                    serialization: 'json'
                });
                
                setupConn();
                myRole = 'Y';
                mode = 'online';
            });

            peer.on('error', err => {
                clearTimeout(connectionTimeout);
                log("Join hatası: " + err.type);
                console.error(err);
                
                if(err.type === 'peer-unavailable') {
                    alert("Oda bulunamadı veya kapalı. Link'i kontrol edin.");
                } else if(err.type === 'network') {
                    alert("Ağ hatası. İnternet bağlantınızı kontrol edin.");
                } else {
                    alert("Bağlantı hatası: " + err.type);
                }
                window.location.href = window.location.pathname;
            });

        } catch(e) {
            log("Join kritik hata: " + e.message);
            console.error(e);
            alert("Başlatma hatası. Ana sayfaya dönülüyor.");
            window.location.href = window.location.pathname;
        }
    }

    function setupConn() {
        conn.on('open', () => {
            log("Veri kanalı açıldı ✓");
            clearTimeout(connectionTimeout);
            
            if(myRole === 'Y') {
                log("Oyun durumu bekleniyor...");
            }
        });

        conn.on('data', d => {
            try {
                if(d.type === 'state') {
                    state = d.val;
                    log("Durum güncellendi");
                    
                    if(document.getElementById('menu-layer').style.display !== 'none') {
                        document.getElementById('menu-layer').style.display='none';
                        document.getElementById('game-layer').style.display='flex';
                    }
                    render();
                } else if (d.type === 'next') {
                    log("Yeni tur başlıyor");
                    resetLogic();
                    render();
                }
            } catch(e) {
                log("Veri işleme hatası: " + e.message);
                console.error(e);
            }
        });

        conn.on('close', () => {
            log("Bağlantı kapandı");
            document.getElementById('disc-modal').style.display='flex';
        });

        conn.on('error', err => {
            log("Bağlantı hatası: " + err);
            console.error(err);
        });
    }

    function nextRound() {
        resetLogic();
        if(mode === 'online') {
            conn.send({type: 'next'});
            sendState();
        }
        render();
    }

    function resetLogic() {
        state.board.fill(null);
        state.phase = 'placing';
        state.placed = {R:0, Y:0};
        state.winner = null;
        state.turn = 'R'; 
        document.getElementById('end-modal').style.display='none';
    }

    function sendState() { 
        if(conn && conn.open) {
            try {
                conn.send({type:'state', val:state});
            } catch(e) {
                log("Gönderme hatası: " + e.message);
            }
        }
    }

    function render() {
        document.getElementById('s1').innerText = state.score.R;
        document.getElementById('s2').innerText = state.score.Y;
        document.getElementById('p1-stat').classList.toggle('active', state.turn==='R');
        document.getElementById('p2-stat').classList.toggle('active', state.turn==='Y');
        
        let txt = "";
        if(mode === 'online') {
            txt = (state.turn === myRole) ? "SIRA SENDE" : "RAKİP BEKLENİYOR";
        } else {
            txt = state.turn === 'R' ? "SIRA: G" : "SIRA: N";
        }
        document.getElementById('turn-text').innerText = txt;

        document.querySelectorAll('.piece').forEach(p => p.remove());
        state.board.forEach((o,i) => { if(o) createPiece(o, i); });
        
        for(let i=0; i<(3-state.placed.R); i++) createPiece('R', -1);
        for(let i=0; i<(3-state.placed.Y); i++) createPiece('Y', -1);

        if(state.winner) {
            const msg = document.getElementById('end-msg');
            if(state.winner === 'DRAW') {
                msg.innerText = "BERABERE!";
                msg.style.color = "#fff";
            } else {
                msg.innerText = (state.winner==='R' ? "G" : "N") + " KAZANDI!";
                msg.style.color = state.winner==='R' ? "var(--neon-g)" : "var(--neon-n)";
            }
            document.getElementById('end-modal').style.display='flex';
        }
    }

    function createPiece(owner, idx) {
        let p = document.createElement('div');
        p.className = `piece ${owner==='R'?'red':'yellow'}`;
        
        if(idx === -1) {
            p.style.position = 'relative'; 
            p.style.width = '50px'; 
            p.style.height = '50px';
            document.getElementById(`pool-${owner}`).appendChild(p);
        } else {
            p.style.left = pos[idx].l + '%'; 
            p.style.top = pos[idx].t + '%';
            p.style.transform = 'translate(-50%, -50%)';
            document.getElementById('board').appendChild(p);
        }

        let canInteract = false;
        if(!state.winner && state.turn === owner) {
            if(mode === 'local') canInteract = true;
            else if(mode === 'online' && myRole === owner) canInteract = true;
        }

        if(canInteract) {
            p.onpointerdown = (e) => startDrag(e, p, idx, owner);
            p.style.cursor = 'grab';
        } else {
            p.style.cursor = 'default';
            p.style.opacity = '0.7';
        }
    }

    let dragged = null;
    let dragOff = {x:0, y:0};

    function startDrag(e, el, idx, owner) {
        if(state.phase === 'moving' && idx === -1) return;
        e.preventDefault();
        
        dragged = el;
        let rect = el.getBoundingClientRect();
        dragOff = {x: e.clientX - rect.left, y: e.clientY - rect.top};

        el.style.position = 'fixed'; 
        el.style.width = rect.width + 'px'; 
        el.style.height = rect.height + 'px';
        el.style.zIndex = 1000; 
        el.style.transform = 'none';
        el.style.cursor = 'grabbing';
        document.body.appendChild(el);
        
        moveDrag(e);

        const move = (ev) => { 
            ev.preventDefault(); 
            moveDrag(ev); 
        };
        
        const end = (ev) => {
            document.removeEventListener('pointermove', move);
            document.removeEventListener('pointerup', end);
            finishDrag(el, idx, owner);
        };
        
        document.addEventListener('pointermove', move);
        document.addEventListener('pointerup', end);
    }

    function moveDrag(e) {
        if(dragged) {
            dragged.style.left = (e.clientX - dragOff.x) + 'px';
            dragged.style.top = (e.clientY - dragOff.y) + 'px';
        }
    }

    function finishDrag(el, oldIdx, owner) {
        let r = el.getBoundingClientRect();
        let c = {x: r.left + r.width/2, y: r.top + r.height/2};
        let closest = -1, minD = 9999;

        document.querySelectorAll('.spot').forEach(s => {
            let sr = s.getBoundingClientRect();
            let sc = {x: sr.left + sr.width/2, y: sr.top + sr.height/2};
            let d = Math.hypot(c.x - sc.x, c.y - sc.y);
            if(d < r.width * 1.5) { 
                if(d < minD) { 
                    minD = d; 
                    closest = parseInt(s.dataset.idx); 
                }
            }
        });

        let valid = false;
        if(closest !== -1 && state.board[closest] === null) {
            if(state.phase === 'placing' && oldIdx === -1) {
                valid = true;
            } else if(state.phase === 'moving' && oldIdx !== -1 && adj[oldIdx].includes(closest)) {
                valid = true;
            }
        }

        if(valid) {
            if(oldIdx !== -1) state.board[oldIdx] = null;
            state.board[closest] = owner;
            if(state.phase === 'placing' && oldIdx === -1) state.placed[owner]++;
            
            if(state.placed.R === 3 && state.placed.Y === 3) {
                state.phase = 'moving';
            }
            
            let win = wins.some(w => w.every(i => state.board[i] === owner));
            if(win) {
                state.score[owner]++;
                state.winner = owner;
            } else {
                state.turn = (owner === 'R') ? 'Y' : 'R';
                
                if(state.phase === 'moving') {
                    let pMoves = state.board.map((x,i) => x===state.turn ? i : -1).filter(x=>x!==-1);
                    if(!pMoves.some(i => adj[i].some(n => state.board[n]===null))) {
                        state.winner='DRAW';
                    }
                }
            }
            
            if(mode === 'online') sendState();
            render();
        } else {
            render();
        }
        
        dragged = null;
    }

    function copyLink() {
        const linkInput = document.getElementById('share-link');
        linkInput.select();
        linkInput.setSelectionRange(0, 99999);
        
        try {
            document.execCommand('copy');
            showToast("Kopyalandı!");
        } catch(e) {
            if(navigator.clipboard) {
                navigator.clipboard.writeText(linkInput.value).then(() => {
                    showToast("Kopyalandı!");
                }).catch(() => {
                    showToast("Manuel kopyala");
                });
            } else {
                showToast("Manuel kopyala");
            }
        }
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.style.opacity = 1;
        setTimeout(() => t.style.opacity = 0, 2000);
    }
</script>
</body>
</html>
