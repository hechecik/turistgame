<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TURİST: Online Üç Taş</title>
<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@400;500&display=swap');

    :root {
        --bg-dark: #0a0b10;
        --board-bg: #14161f;
        --line-color: #2c3e50;
        --neon-red: #ff0055;
        --neon-yellow: #ffcc00;
        --neon-blue: #00f3ff;
        --glass: rgba(255, 255, 255, 0.05);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
        margin: 0; padding: 0;
        height: 100vh; width: 100vw;
        background: radial-gradient(circle at center, #1a1c29 0%, var(--bg-dark) 100%);
        color: #fff;
        font-family: 'Roboto', sans-serif;
        display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
        overflow: hidden; user-select: none;
    }

    /* --- MENÜ EKRANI --- */
    #menu-screen {
        position: absolute; inset: 0; z-index: 2000;
        background: var(--bg-dark);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        gap: 20px; transition: opacity 0.5s;
    }
    .game-title {
        font-family: 'Orbitron', sans-serif; font-size: 3rem;
        background: linear-gradient(90deg, var(--neon-red), var(--neon-yellow));
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        text-shadow: 0 0 20px rgba(255, 0, 85, 0.5); margin-bottom: 20px;
    }
    .menu-btn {
        padding: 15px 40px; font-size: 1.2rem; border-radius: 50px; border: none;
        background: linear-gradient(45deg, var(--neon-blue), #0066ff);
        color: white; font-weight: bold; cursor: pointer;
        box-shadow: 0 0 15px rgba(0, 243, 255, 0.4);
    }
    .link-box {
        background: #222; padding: 15px; border-radius: 10px; border: 1px solid #444;
        display: none; flex-direction: column; align-items: center; gap: 10px;
        max-width: 90%; word-break: break-all; text-align: center;
    }

    /* --- OYUN EKRANI --- */
    .header {
        width: 100%; padding: 15px; display: flex; justify-content: space-between; align-items: center;
        max-width: 500px;
    }
    .status-badge {
        padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; font-weight: bold;
        background: var(--glass); border: 1px solid rgba(255,255,255,0.1);
    }

    .scoreboard {
        display: flex; gap: 20px; margin-bottom: 10px;
        background: var(--glass); padding: 10px 30px; border-radius: 15px;
        border: 1px solid rgba(255,255,255,0.1);
    }
    .p-score { text-align: center; opacity: 0.5; transition: 0.3s; }
    .p-score.active { opacity: 1; transform: scale(1.1); text-shadow: 0 0 10px currentColor; }
    .score-val { font-size: 1.8rem; font-family: 'Orbitron'; display: block; }
    .color-r { color: var(--neon-red); }
    .color-y { color: var(--neon-yellow); }

    /* Oyun Alanı Konteyner */
    .game-container {
        position: relative;
        width: 90vmin; max-width: 400px;
        display: flex; flex-direction: column; align-items: center;
    }

    /* TAHTA */
    .board {
        width: 100%; aspect-ratio: 1/1;
        background: var(--board-bg);
        border-radius: 15px;
        position: relative;
        box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }

    /* Çizgiler */
    .lines { width: 100%; height: 100%; position: absolute; pointer-events: none; }
    .lines line { stroke: #3e4a5e; stroke-width: 4px; stroke-linecap: round; }

    /* Noktalar (Drop Zones) */
    .spot {
        position: absolute; width: 60px; height: 60px;
        transform: translate(-50%, -50%);
        border-radius: 50%;
        z-index: 5;
        /* Debug için border açılabilir: border: 1px solid white; */
    }

    /* TAŞLAR */
    .piece {
        width: 50px; height: 50px; /* Sabit pixel boyutu */
        border-radius: 50%;
        position: absolute;
        z-index: 10;
        cursor: grab;
        display: flex; align-items: center; justify-content: center;
        font-weight: bold; color: rgba(0,0,0,0.5);
        box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        touch-action: none;
        transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    .piece.dragging {
        transition: none; /* Sürüklerken animasyonu kapat */
        z-index: 1000;
        pointer-events: none; /* Altındaki spot'u görebilmek için */
        transform: scale(1.2);
    }

    /* Kırmızı Taş Tasarımı */
    .piece.red {
        background: radial-gradient(circle at 30% 30%, #ff5e95, #d60041);
        border: 2px solid #ff9dbf;
        box-shadow: 0 0 15px var(--neon-red);
    }
    /* Sarı Taş Tasarımı */
    .piece.yellow {
        background: radial-gradient(circle at 30% 30%, #ffd633, #e6b800);
        border: 2px solid #ffff99;
        box-shadow: 0 0 15px var(--neon-yellow);
    }

    /* Havuzlar */
    .pools {
        width: 100%; display: flex; justify-content: space-between; margin-top: 20px;
        height: 70px;
    }
    .pool {
        width: 45%; background: rgba(255,255,255,0.05); border-radius: 10px;
        display: flex; justify-content: center; align-items: center; gap: 5px;
        border: 1px solid rgba(255,255,255,0.1);
    }

    /* Mesaj / Modal */
    .modal-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.9);
        display: none; align-items: center; justify-content: center; z-index: 3000;
        backdrop-filter: blur(10px);
    }
    .modal-box {
        background: #1a1a1a; padding: 30px; border-radius: 20px;
        border: 1px solid var(--neon-blue); text-align: center; width: 80%; max-width: 300px;
    }
    .modal-msg { font-size: 1.5rem; margin-bottom: 20px; font-family: 'Orbitron'; }

    /* Bildirim */
    #toast {
        position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
        background: #333; padding: 10px 20px; border-radius: 30px;
        opacity: 0; pointer-events: none; transition: 0.3s; z-index: 4000;
    }
</style>
</head>
<body>

    <div id="menu-screen">
        <div class="game-title">TURİST</div>
        <div id="initial-buttons">
            <button class="menu-btn" onclick="createGame()">Oda Oluştur</button>
            <p style="opacity:0.6; margin-top:10px">veya bir linke tıkla</p>
        </div>
        
        <div id="wait-box" class="link-box">
            <p>Oda oluşturuldu! Bu linki arkadaşına at:</p>
            <input type="text" id="share-link" readonly style="width:100%; background:#111; border:1px solid #444; color:#0f0; padding:10px; border-radius:5px; text-align:center;">
            <button class="menu-btn" onclick="copyLink()" style="font-size:0.9rem; padding:10px 20px; margin-top:10px;">Linki Kopyala</button>
            <p style="color:var(--neon-yellow); animation: pulse 1s infinite;">Rakip bekleniyor...</p>
        </div>
        <div id="status-text" style="color:#666; margin-top:20px; font-size:0.8rem;">Sunucuya bağlanılıyor...</div>
    </div>

    <div class="header">
        <div class="status-badge" id="role-badge">İzleyici</div>
        <div class="status-badge" id="turn-badge" style="color:var(--neon-blue)">Bekleniyor</div>
    </div>

    <div class="scoreboard">
        <div class="p-score color-r" id="score-r">
            <small>KIRMIZI</small>
            <span class="score-val" id="s-red">0</span>
        </div>
        <div class="p-score color-y" id="score-y">
            <small>SARI</small>
            <span class="score-val" id="s-yellow">0</span>
        </div>
    </div>

    <div class="game-container">
        <div class="board" id="board">
            <svg class="lines">
                <line x1="10%" y1="10%" x2="90%" y2="10%"/>
                <line x1="90%" y1="10%" x2="90%" y2="90%"/>
                <line x1="90%" y1="90%" x2="10%" y2="90%"/>
                <line x1="10%" y1="90%" x2="10%" y2="10%"/>
                <line x1="50%" y1="10%" x2="50%" y2="90%"/>
                <line x1="10%" y1="50%" x2="90%" y2="50%"/>
                <line x1="10%" y1="10%" x2="90%" y2="90%"/>
                <line x1="90%" y1="10%" x2="10%" y2="90%"/>
            </svg>
            </div>

        <div class="pools">
            <div class="pool" id="pool-R"></div>
            <div class="pool" id="pool-Y"></div>
        </div>
    </div>

    <div class="modal-overlay" id="end-modal">
        <div class="modal-box">
            <div class="modal-msg" id="end-msg">KAZANDIN!</div>
            <button class="menu-btn" onclick="requestRematch()">Tekrar Oyna</button>
        </div>
    </div>

    <div id="toast">Link Kopyalandı!</div>

<script>
    // --- KONFİGÜRASYON & DEĞİŞKENLER ---
    const pos = [
        {l:10, t:10}, {l:50, t:10}, {l:90, t:10},
        {l:10, t:50}, {l:50, t:50}, {l:90, t:50},
        {l:10, t:90}, {l:50, t:90}, {l:90, t:90}
    ];
    // Komşuluklar (0-8 arası indexler)
    const adj = [
        [1,3,4], [0,2,4], [1,5,4],
        [0,4,6], [0,1,2,3,5,6,7,8], [2,4,8],
        [3,4,7], [6,4,8], [4,5,7]
    ];
    const wins = [
        [0,1,2], [3,4,5], [6,7,8], // Yatay
        [0,3,6], [1,4,7], [2,5,8], // Dikey
        [0,4,8], [2,4,6]           // Çapraz
    ];

    let myId = null;
    let peer = null;
    let conn = null;
    let myRole = null; // 'R' (Host) or 'Y' (Joiner)
    let gameActive = false;
    
    // Oyun Durumu
    let state = {
        board: Array(9).fill(null),
        turn: 'R', // Kırmızı başlar
        phase: 'placing',
        placedCount: { R: 0, Y: 0 },
        score: { R: 0, Y: 0 }
    };

    // DOM Elemanları
    const els = {
        menu: document.getElementById('menu-screen'),
        board: document.getElementById('board'),
        poolR: document.getElementById('pool-R'),
        poolY: document.getElementById('pool-Y'),
        status: document.getElementById('status-text'),
        waitBox: document.getElementById('wait-box'),
        linkInput: document.getElementById('share-link'),
        turnBadge: document.getElementById('turn-badge'),
        roleBadge: document.getElementById('role-badge'),
        sRed: document.getElementById('s-red'),
        sYellow: document.getElementById('s-yellow'),
        scoreR: document.getElementById('score-r'),
        scoreY: document.getElementById('score-y'),
        modal: document.getElementById('end-modal'),
        endMsg: document.getElementById('end-msg')
    };

    // --- BAŞLANGIÇ ---
    function init() {
        createSpots();
        
        // URL'de ID var mı kontrol et
        const urlParams = new URLSearchParams(window.location.search);
        const joinId = urlParams.get('id');

        peer = new Peer(null, { debug: 1 }); // PeerJS sunucusuna bağlan

        peer.on('open', (id) => {
            myId = id;
            els.status.innerText = "Sunucuya bağlanıldı. ID: " + id;
            
            if (joinId) {
                // Link ile gelindi, otomatik katıl
                joinGame(joinId);
            }
        });

        peer.on('connection', (connection) => {
            // Sadece Host buraya düşer (Bağlantı kabul eder)
            if (conn) { connection.close(); return; } // Zaten biri var
            conn = connection;
            setupConnection();
            startGame('R'); // Host her zaman Kırmızıdır
        });

        peer.on('error', (err) => {
            alert("Bağlantı hatası: " + err);
        });
    }

    function createGame() {
        document.getElementById('initial-buttons').style.display = 'none';
        els.waitBox.style.display = 'flex';
        const link = window.location.origin + window.location.pathname + '?id=' + myId;
        els.linkInput.value = link;
    }

    function joinGame(hostId) {
        document.getElementById('initial-buttons').style.display = 'none';
        els.status.innerText = "Odaya bağlanılıyor...";
        conn = peer.connect(hostId);
        setupConnection();
        // Joiner Sarı olur, ama oyun başlamasını Host'tan gelen veri tetikler
    }

    function setupConnection() {
        conn.on('open', () => {
            console.log("Bağlantı Kuruldu!");
            els.menu.style.opacity = '0';
            setTimeout(() => { els.menu.style.display = 'none'; }, 500);
        });

        conn.on('data', (data) => {
            handleNetworkData(data);
        });

        conn.on('close', () => {
            alert("Rakip oyundan ayrıldı.");
            location.reload();
        });
    }

    function copyLink() {
        els.linkInput.select();
        document.execCommand('copy');
        const t = document.getElementById
